# Oracle Cloud Infrastructure (OCI) WAF ハンズオン用攻撃スクリプト

## 注意
このスクリプトは、OCIのハンズオン用途にのみ使用できます。このスクリプトのご自身の管理下にないサイトへのアクセスには使用しないでください。

また、各パラメーターを無闇に増やしてアクセス回数を増やしたり、続けて何度も実行したりすると、たとえ意図していなくても、そのアクセスが攻撃であると認識され、アクセスが遮断されたりサービスを切断されるなどの。予期せぬ自体を巻き起こすことがありますので。注意してください。

このスクリプトを利用したことで不利益を被った場合にも作者はその責務は負いません。

## 使い方
### 前提条件
1. Webサーバー、OCI WAF、DNSが正しく構成され、正しくHTTPリクエストを返すこと
1. WAFポリシーで、全ての保護ルールが検知またはブロックに設定されていること、またBot管理のヒューマン・インタラクション・チャレンジの検出またはブロックが設定されていること
1. 攻撃スクリプトを実行するために、Bashが実行できるクライアントがあること
1. この攻撃スクリプトを実行するクライアントから、WAFに対して正しくアクセスできること(ファイアウォールでブロックされていないこと) ※社内環境などファイアウォール内部からの実行はうまくいかない場合があります
1. クライアントに Apache Benchmark がインストールされ、```ab``` コマンドにパスが通っていること

クライアントにはOCIコンソールのCloud Shellがお勧めです。Cloud Shellであれば、3~5は特に問題なく満たすことができます。

### インストールとセットアップ
このリポジトリをクローンします
https://github.com/mmarukaw/oci-waf-handson.git

oci-waf-handson/attack-scripts にある config をエディタで開き、パラメーターを編集します。

```
# WAF secured host
# 講師の指示に従って、ホスト名を変更してください。
WAFSecuredHost=<WAFでブロックされたホストのFQDN>

# Path for vulnerability test
VulnerabilityPath=<スクリプトがアクセスするURIパス>

# Language
Language=<スクリプトのガイドの言語 JA/EN>
```

この攻撃スクリプトには、6個のシナリオが用意されています。それぞれのシナリオが、attack-scripts 以下にある01から06で始まるシェルスクリプトファイルが対応しています。

### シナリオ1~5 保護ルールの有効性の確認

シナリオ1から5までは、ルールベースのファイアウォールである、保護ルールの有効性を確認するためのものです。
それぞれのシナリオが、WAFの特定の保護ルールに抵触するようなロジックで、WAFの背後にあるWebサーバーへのアクセスを10回ずつ試みます。
WAFが正しく構成されていれば、WAFのフィルター機能が働き、ログに「検出」または「ブロック」で出力されます。(どちらが出力されるかは、WAFの設定によります)
もし「ブロック」に設定していた場合には、クライアントに返る応答は200 OKではなく、4xx番台などになります。(実際のレスポンスコードは、これもWAFの設定によります)

#### 攻撃スクリプトの実行

スクリプトを実行するには、attack-scripts ディレクトリで、以下の例のようなコマンドを発行してください。
```. ./01-php-code-injection-protection-rule-950002.sh```

そうすると、対話式のダイアログが流れます。基本的にはENTERキーを押していくだけで完了します。
```
--------------------------------------
01. PHPコードインジェクション攻撃 (保護ルールID-950002)

以下のPHPインジェクション攻撃コマンドを10回実行します。
curl -lvk -verbose http://web0.block.ociwaf.tk//?a=telnet.exe
--------------------------------------
ENTERキーを押してください: 

(中略)

--------------------------------------
攻撃が完了しました。

HTTPレスポンスコードが403の場合は、WAFによってトラフィックがブロッックされたことを示しています。WAFを検出のみに設定している場合は、オリジンサーバー(Webサーバー)までトラフィックが到達するため、レスポンスコードが200になります。

また、HTTPレスポンスの中の *.ZENEDGE という表示は、攻撃したトラフィックが Oracle Cloud Infrastructure (OCI) の Webアプリケーション・ファイアウォール (WAF) を経由してオリジン・サーバー (Webサーバー) と通信していることを示しています。

OCI コンソールの WAF ポリシーのページにアクセスし、ログに出力されている攻撃の詳細を確認してください。
--------------------------------------
```

#### WAFコンソールでのログの確認
攻撃が完了したら、ociのコンソールで、WAFのログを閲覧します。(セキュリティ→WEBアプリケーション・ファイアウォール→該当のWAFポリシーを選択→ログ)
ログには、1回のHTTPリクエストごとに「アクセス」というタイプのログが1行、そして「検出」または「ブロック」というタイプのログが1行の2行が出力されています。
これは、HTTPリクエストが1回試行され、それをWAFが「悪意あるリクエストとして検出はしたがそのままリクエストをオリジンサーバーに通した」、または「悪意あるリクエストとしてブロックした(のでオリジンサーバーにはリクエストが転送されていない)」のどちらかであることを示します。
今回は、クライアントから10回のリクエストを投げているので、皆さんのWAFには10レコードの「アクセス」と、10レコードの「検出」または「ブロック」が記録されているはずです。

「検出」または「ブロック」となっているログの詳細をあけ、「JSONの表示」ボタンを押すと、より詳細なレポートが閲覧できます。

JSONファイルにはHTTPヘッダーを中心に様々な情報が記録されていますが、ここではどの保護ルールが働いたかを示す `protectionRuleDetections` に注目してみてください。

例えば下記の例は、ルールID 950002、950006 に抵触したために、悪意のあるアクセスとしてWAFが判断したことを示しています。
これらのルールの簡単な説明は `Message details` フィールドに記載されていますが、OCIコンソールの`保護ルール`からも説明を見ることができます。

```
"protectionRuleDetections": {
    "950002": {
      "Message": "Pattern match \"\\\\b(?:(?:n(?:map|et|c)|w(?:guest|sh)|telnet|rcmd|ftp)\\\\.exe\\\\b|cmd(?:(?:32)?\\\\.exe\\\\b|\\\\b\\\\W*?\\\\/c))\" at ARGS:a.",
      "Message details": "Matched Data: telnet.exe found within ARGS:a: telnet.exe"
    },
    "950006": {
      "Message": "Pattern match \"(?:\\\\b(?:(?:n(?:et(?:\\\\b\\\\W+?\\\\blocalgroup|\\\\.exe)|(?:map|c)\\\\.exe)|t(?:racer(?:oute|t)|elnet\\\\.exe|clsh8?|ftp)|(?:w(?:guest|sh)|rcmd|ftp)\\\\.exe|echo\\\\b\\\\W*?\\\\by+)\\\\b|c(?:md(?:(?:\\\\.exe|32)\\\\b|\\\\b\\\\W*?\\\\/c)|d(?:\\\\b\\\\W*?[\\\\/]|\\\\W*?\\\\.\\\\.)|hmod.{0,40}?\\\\ ...\" at ARGS:a.",
      "Message details": "Matched Data: telnet.exe found within ARGS:a: telnet.exe"
    }
  },
```

### シナリオ6 Bot保護の有効性の確認

シナリオ6については、1~5までとは異なり、HTTPリクエスト単体では特に有害であるとは判定できないが、総合的にみて悪意のある攻撃者からのアクセスである可能性の高いアクセスを、WAFがどう遮断していくかについての確認を行うものです。
シナリオ6で用いるクエリーは、ホームページに対する通常のGETアクセスです。これ自体は全く無害なものではありませんが、今回はこれを `apache benchmark` というツールを使って短時間に1000回アクセスを試みます。(レイヤー7 DOS攻撃を模しています)

WAFで、Bot保護機能が有効であると、このように短時間での多数のアクセスを、通常の人間ではないBotによる不正なアクセスと判断し、アクセスを遮断します。
今回はBot保護機能のうち、`ヒューマン・インタラクション・チャレンジ`という仕組みを有効化しているはずですので、こちらによる検出(またはブロック)を期待します。

#### 攻撃スクリプトの実行

スクリプトを実行するには、attack-scripts ディレクトリで、以下の例のようなコマンドを発行してください。
```. ./06-Layer7-DDoS-Distributed-Denial-of-Service-Apache-Benchmark.sh```

その先は、先ほどまでのスクリプトと同じく、対話式のダイアログが流れます。基本的にはENTERキーを押していくだけで完了します。
全てが完了すると、レポートが出力されます。
その中の、以下のような箇所に注目してみてください。これは、1000回リクエストを送り、そのうち899回がFailedになっていることを示しています。

```
Concurrency Level:      100
Time taken for tests:   7.615 seconds
Complete requests:      1000
Failed requests:        899
   (Connect: 0, Receive: 0, Length: 899, Exceptions: 0)
```

少しログを上にスクロールしていくと、Failedになったリクエストのレスポンスが出力されているはずです。

```
LOG: header received:
HTTP/1.1 403 Forbidden
Date: Fri, 25 Sep 2020 05:32:13 GMT
Content-Type: text/html
Content-Length: 950
Connection: close
Cache-Control: no-store
Cache-Control: no-cache, no-store, must-revalidate
Cache-Control: max-age=0
X-Zen-Fury: b38cde8cc5e259b0bebdb075d72621161d6dd08b
Server: ZENEDGE
X-Cdn: Served-By-Zenedge
```

もし上記のようなレスポンスが見つかったら、それはOCI WAF (ここでは旧製品名のZENEDGEと表示されています) がリクエストをブロックし、403 Forbidden を返してきていることがわかります。
もしBot保護機能を「ブロック」ではなく「検出」で設定している場合は、全てのリクエストが 200 OK で返ってきているはずです。

#### WAFコンソールでのログの確認
ociのコンソールで、WAFのログを閲覧します。(セキュリティ→WEBアプリケーション・ファイアウォール→該当のWAFポリシーを選択→ログ)
今回は1000回のリクエストを行ったので、1000回の「アクセス」ログと、それより少ない数の「検出」または「ブロック」ログが出力されています。
上記の例だと、ブロックの数は899回、つまりクライアントが「Fail」として受け取った数と同じになるはずです。

なぜアクセスのレコード数 1000 と同じにならないかは、Bot保護の働きの特性によります。
今回のアクセスは、それ自体では悪意のあるアクセスであるとは判断できないために、アクセスの最初の頃にはWAFはそのままリクエストをオリジンサーバーに転送します。しかし、あまりにも短時間のうちに同じクライアントと思われるものから多くのリクエストがきているために、ある時これを悪意のあるアクセスであると判断し、それ以降のアクセスをブロックしたために、最初のうちにタイムラグが発生します。

このように、本来Botからのアクセスのために遮断するべきアクセスが遮断できていないものを、偽陰性(False Negative)と呼びます。
逆に、本来通したい正常なアクセスをWAFが誤って遮断してしまうことを、偽陽性(False Negative)と呼びます。
WAFを実際に導入する際には、この偽陰性や偽陽性をどう減らしていくかを、Bot保護のパラメーターのチューニングによって行います。
