# Oracle Cloud Infrastructure (OCI) WAF ハンズオン用攻撃スクリプト

## 注意
このスクリプトは、OCIのハンズオン用途にのみ使用できます。このスクリプトのご自身の管理下にないサイトへのアクセスには使用しないでください。

また、各パラメーターを無闇に増やしてアクセス回数を増やしたり、続けて何度も実行したりすると、たとえ意図していなくても、そのアクセスが攻撃であると認識され、アクセスが遮断されたりサービスを切断されるなどの。予期せぬ自体を巻き起こすことがありますので。注意してください。

このスクリプトを利用したことで不利益を被った場合にも作者はその責務は負いません。

## 使い方
### 前提条件
1. Webサーバー、OCI WAF、DNSが正しく構成され、正しくHTTPリクエストを返すこと
1. WAFポリシーで、全ての保護ルールが検知またはブロックに設定されていること、またBot管理のヒューマン・インタラクション・チャレンジの検出またはブロックが設定されていること
1. 攻撃スクリプトを実行するために、Bashが実行できるクライアントがあること
1. この攻撃スクリプトを実行するクライアントから、WAFに対して正しくアクセスできること(ファイアウォールでブロックされていないこと) ※社内環境などファイアウォール内部からの実行はうまくいかない場合があります
1. クライアントに Apache Benchmark がインストールされ、```ab``` コマンドにパスが通っていること

クライアントにはOCIコンソールのCloud Shellがお勧めです。Cloud Shellであれば、3~5は特に問題なく満たすことができます。

### インストールとセットアップ
このリポジトリをクローンします
https://github.com/mmarukaw/oci-waf-handson.git

oci-waf-handson/attack-scripts にある config をエディタで開き、パラメーターを編集します。

```
# WAF secured host
# 講師の指示に従って、ホスト名を変更してください。
WAFSecuredHost=<WAFでブロックされたホストのFQDN>

# Path for vulnerability test
VulnerabilityPath=<スクリプトがアクセスするURIパス>

# Language
Language=<スクリプトのガイドの言語 JA/EN>
```

### スクリプトの実行
この攻撃スクリプトには、6個のシナリオが用意されています。それぞれのシナリオが、attack-scripts 以下にある01から06で始まるシェルスクリプトファイルが対応しています。

#### シナリオ1~5 保護ルールの有効性の確認
シナリオ1から5までは、ルールベースのファイアウォールである、保護ルールの有効性を確認するためのものです。
それぞれのシナリオが、WAFの特定の保護ルールに抵触するようなロジックで、WAFの背後にあるWebサーバーへのアクセスを10回ずつ試みます。
WAFが正しく構成されていれば、WAFのフィルター機能が働き、ログに「検出」または「ブロック」で出力されます。(どちらが出力されるかは、WAFの設定によります)
もし「ブロック」に設定していた場合には、クライアントに返る応答は200 OKではなく、4xx番台などになります。(実際のレスポンスコードは、これもWAFの設定によります)

スクリプトを実行するには、attack-scripts ディレクトリで、以下の例のようなコマンドを発行してください。
```. ./01-php-code-injection-protection-rule-950002.sh```

そうすると、対話式のダイアログが流れます。基本的にはENTERキーを押していくだけで完了します。
```
--------------------------------------
01. PHPコードインジェクション攻撃 (保護ルールID-950002)

以下のPHPインジェクション攻撃コマンドを10回実行します。
curl -lvk -verbose http://web0.block.ociwaf.tk//?a=telnet.exe
--------------------------------------
ENTERキーを押してください: 

(中略)

--------------------------------------
攻撃が完了しました。

HTTPレスポンスコードが403の場合は、WAFによってトラフィックがブロッックされたことを示しています。WAFを検出のみに設定している場合は、オリジンサーバー(Webサーバー)までトラフィックが到達するため、レスポンスコードが200になります。

また、HTTPレスポンスの中の *.ZENEDGE という表示は、攻撃したトラフィックが Oracle Cloud Infrastructure (OCI) の Webアプリケーション・ファイアウォール (WAF) を経由してオリジン・サーバー (Webサーバー) と通信していることを示しています。

OCI コンソールの WAF ポリシーのページにアクセスし、ログに出力されている攻撃の詳細を確認してください。
--------------------------------------
```

攻撃が完了したら、ociのコンソールで、WAFのログを閲覧します。(セキュリティ→WEBアプリケーション・ファイアウォール→該当のWAFポリシーを選択→ログ)
ログには、1回のHTTPリクエストごとに「アクセス」というタイプのログが1行、そして「検出」または「ブロック」というタイプのログが1行の2行が出力されています。
これは、HTTPリクエストが1回試行され、それをWAFが「悪意あるリクエストとして検出はしたがそのままリクエストをオリジンサーバーに通した」、または「悪意あるリクエストとしてブロックした(のでオリジンサーバーにはリクエストが転送されていない)」のどちらかであることを示します。
今回は、クライアントから10回のリクエストを投げているので、皆さんのWAFには10レコードの「アクセス」と、10レコードの「検出」または「ブロック」が記録されているはずです。

「検出」または「ブロック」となっているログの詳細をあけ、「JSONの表示」ボタンを押すと、より詳細なレポートが閲覧できます。

JSONファイルにはHTTPヘッダーを中心に様々な情報が記録されていますが、ここではどの保護ルールが働いたかを示す `protectionRuleDetections` に注目してみてください。

例えば下記の例は、ルールID 950002、950006 に抵触したために、悪意のあるアクセスとしてWAFが判断したことを示しています。
これらのルールの簡単な説明は `Message details` フィールドに記載されていますが、OCIコンソールの`保護ルール`からも説明を見ることができます。

```
"protectionRuleDetections": {
    "950002": {
      "Message": "Pattern match \"\\\\b(?:(?:n(?:map|et|c)|w(?:guest|sh)|telnet|rcmd|ftp)\\\\.exe\\\\b|cmd(?:(?:32)?\\\\.exe\\\\b|\\\\b\\\\W*?\\\\/c))\" at ARGS:a.",
      "Message details": "Matched Data: telnet.exe found within ARGS:a: telnet.exe"
    },
    "950006": {
      "Message": "Pattern match \"(?:\\\\b(?:(?:n(?:et(?:\\\\b\\\\W+?\\\\blocalgroup|\\\\.exe)|(?:map|c)\\\\.exe)|t(?:racer(?:oute|t)|elnet\\\\.exe|clsh8?|ftp)|(?:w(?:guest|sh)|rcmd|ftp)\\\\.exe|echo\\\\b\\\\W*?\\\\by+)\\\\b|c(?:md(?:(?:\\\\.exe|32)\\\\b|\\\\b\\\\W*?\\\\/c)|d(?:\\\\b\\\\W*?[\\\\/]|\\\\W*?\\\\.\\\\.)|hmod.{0,40}?\\\\ ...\" at ARGS:a.",
      "Message details": "Matched Data: telnet.exe found within ARGS:a: telnet.exe"
    }
  },
```


